#!/bin/sh

# freevo - the main entry point to the whole suite of applications
#
# $Id$
#

# Keep track of where we started. This env var is used inside Freevo.
export FREEVO_STARTDIR=$PWD

# Set this globaly, everything here should have access to these modules.
export PYTHONPATH=./src:./src/www:./src/tv

# cd to the freevo directory if necessary
if ! [ -e src/identifymedia.py ]; then
    cd `dirname $0`
fi

if [ "$1" = "update" ] ; then
    if [ "$2" = "" ]; then
	echo "usage: freevo update path-of-freevo-binary-release"
	echo
	echo "warning: the update will delete all files in the src and"
	echo "and the skin directory except the personal plugins."
	exit 1
    fi
    echo "updating freevo binary release in $2"
    find $2/src | grep -v /plugins/ | xargs rm -rf
    rm -rf $2/src/skins $2/WIP
    cp -r * $2
    exit 0
fi

# Is runapp present? If not it needs to be compiled
if ! [ -e runapp ]; then
    echo
    echo "*************************************************************"
    echo "* Please note that there is a standalone binary release     *"
    echo "* of Freevo with all dependencies included. Use that unless *"
    echo "* you are really capable of installing Freevo from source   *"
    echo "* without assistance from the mailing lists or irc!         *"
    echo "*************************************************************"
    echo
    echo "Freevo not compiled (runapp executable not found)"
    echo
    exit 1
fi

# Create the config file.
if [ "$1" = "setup" ] ; then
    shift 1
    ./runapp python setup_freevo.py $@
    exit 0
fi

# Is freevo.conf present? If not, ./configure is needed
# Check the possible locations in prio order
if ! [ -e $FREEVO_STARTDIR/freevo.conf ]; then
    if ! [ -e $HOME/.freevo/freevo.conf ]; then
        if ! [ -e /etc/freevo/freevo.conf ]; then
            if ! [ -e ./freevo.conf ]; then
                echo "Please run 'freevo setup' first (freevo.conf not found)"
                exit 1
            fi
        fi
    fi
fi

# Support for using just Python
if [ "$1" = "prompt" ] ; then
    ./runapp python
    exit 0
fi
    
# Support executing a standalone Python application, e.g. epg_xmltv.py
# Usage: freevo execute appname.py arg1 arg2...
if [ "$1" = "execute" ] ; then
    shift 1
    ./runapp python $@
    exit 0
fi

# Start the main freevo application
./runapp python src/main.py $@

# Freevo exited, make sure all children are killed
sleep 1
kill -9 `pgrep -f "python src/main.py" -d" "` > /dev/null 2>&1
kill -9 `pgrep -f freevo_python -d" "` > /dev/null 2>&1
killall -9 freevo_loader > /dev/null 2>&1
killall -9 freevo_xwin > /dev/null 2>&1

exit 0
